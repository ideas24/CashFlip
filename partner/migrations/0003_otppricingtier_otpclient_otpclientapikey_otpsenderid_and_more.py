# Generated by Django 5.2.9 on 2026-02-17 23:28

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('partner', '0002_seed_elitebet'),
    ]

    operations = [
        migrations.CreateModel(
            name='OTPPricingTier',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='Tier name e.g. Starter, Growth, Enterprise', max_length=50, unique=True)),
                ('min_monthly_volume', models.PositiveIntegerField(default=0, help_text='Min OTPs/month for this tier')),
                ('max_monthly_volume', models.PositiveIntegerField(default=0, help_text='Max OTPs/month (0=unlimited)')),
                ('price_per_otp_whatsapp', models.DecimalField(decimal_places=4, default=0.03, help_text='Cost per WhatsApp OTP in GHS', max_digits=8)),
                ('price_per_otp_sms', models.DecimalField(decimal_places=4, default=0.05, help_text='Cost per SMS OTP in GHS', max_digits=8)),
                ('whitelabel_fee_monthly', models.DecimalField(decimal_places=2, default=0, help_text='Monthly fee for custom sender ID / whitelabel (0=not available)', max_digits=10)),
                ('whitelabel_available', models.BooleanField(default=False, help_text='Whether custom sender ID is available on this tier')),
                ('monthly_base_fee', models.DecimalField(decimal_places=2, default=0, help_text='Monthly platform fee (0=pay-per-use only)', max_digits=10)),
                ('priority_support', models.BooleanField(default=False)),
                ('sla_uptime', models.DecimalField(decimal_places=2, default=99.0, help_text='SLA uptime guarantee %', max_digits=5)),
                ('display_order', models.PositiveIntegerField(default=0)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'OTP Pricing Tier',
                'ordering': ['display_order', 'min_monthly_volume'],
            },
        ),
        migrations.CreateModel(
            name='OTPClient',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('company_name', models.CharField(help_text='Business name', max_length=200)),
                ('slug', models.SlugField(help_text='URL-safe identifier', unique=True)),
                ('contact_email', models.EmailField(max_length=254)),
                ('contact_phone', models.CharField(blank=True, default='', max_length=20)),
                ('website', models.URLField(blank=True, default='')),
                ('status', models.CharField(choices=[('pending', 'Pending Approval'), ('active', 'Active'), ('suspended', 'Suspended'), ('deactivated', 'Deactivated')], db_index=True, default='pending', max_length=15)),
                ('rate_limit_per_minute', models.PositiveIntegerField(default=60, help_text='Max OTP requests per minute across all keys')),
                ('rate_limit_per_phone_per_hour', models.PositiveIntegerField(default=5, help_text='Max OTPs to same phone number per hour')),
                ('daily_limit', models.PositiveIntegerField(default=10000, help_text='Max OTPs per day (0=unlimited)')),
                ('otp_length', models.PositiveSmallIntegerField(default=6, help_text='OTP code length (4-8)')),
                ('otp_expiry_seconds', models.PositiveIntegerField(default=300, help_text='OTP validity in seconds')),
                ('allowed_channels', models.JSONField(default=list, help_text='["whatsapp","sms"] â€” channels this client can use')),
                ('default_channel', models.CharField(default='whatsapp', help_text='Default delivery channel', max_length=10)),
                ('callback_url', models.URLField(blank=True, default='', help_text='Webhook URL for delivery status callbacks')),
                ('callback_secret', models.CharField(blank=True, default='', help_text='HMAC secret for signing callback payloads', max_length=128)),
                ('prepaid_balance', models.DecimalField(decimal_places=2, default=0, help_text='Prepaid credit balance in GHS', max_digits=12)),
                ('billing_mode', models.CharField(choices=[('prepaid', 'Prepaid'), ('postpaid', 'Postpaid')], default='prepaid', help_text='Prepaid deducts per OTP; postpaid invoices monthly', max_length=10)),
                ('auto_suspend_on_zero', models.BooleanField(default=True, help_text='Auto-suspend when prepaid balance reaches zero')),
                ('ip_whitelist', models.JSONField(blank=True, default=list, help_text='List of allowed IPs (empty=allow all)')),
                ('notes', models.TextField(blank=True, default='')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('operator', models.OneToOneField(blank=True, help_text='Link to game operator if this is a GaaS partner', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='otp_client', to='partner.operator')),
                ('pricing_tier', models.ForeignKey(help_text='Current pricing tier', on_delete=django.db.models.deletion.PROTECT, related_name='clients', to='partner.otppricingtier')),
            ],
            options={
                'verbose_name': 'OTP Client',
                'ordering': ['company_name'],
            },
        ),
        migrations.CreateModel(
            name='OTPClientAPIKey',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('label', models.CharField(default='Default', max_length=100)),
                ('api_key', models.CharField(db_index=True, help_text='Public key sent in X-OTP-Key header', max_length=64, unique=True)),
                ('api_secret', models.CharField(help_text='HMAC secret for signing requests', max_length=128)),
                ('is_active', models.BooleanField(default=True)),
                ('last_used_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('revoked_at', models.DateTimeField(blank=True, null=True)),
                ('client', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='api_keys', to='partner.otpclient')),
            ],
            options={
                'verbose_name': 'OTP API Key',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='OTPSenderID',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('channel', models.CharField(choices=[('whatsapp', 'WhatsApp'), ('sms', 'SMS')], max_length=10)),
                ('whatsapp_phone_number_id', models.CharField(blank=True, default='', help_text='Client WhatsApp Business phone number ID (Meta)', max_length=50)),
                ('whatsapp_access_token', models.TextField(blank=True, default='', help_text='Client WhatsApp Business access token (encrypted at rest)')),
                ('whatsapp_template_name', models.CharField(blank=True, default='', help_text='Client custom auth template name', max_length=100)),
                ('whatsapp_business_name', models.CharField(blank=True, default='', help_text='Display name shown to recipients', max_length=200)),
                ('sms_sender_id', models.CharField(blank=True, default='', help_text='Alphanumeric sender ID for SMS (max 11 chars)', max_length=11)),
                ('sms_provider', models.CharField(blank=True, choices=[('twilio', 'Twilio'), ('arkesel', 'Arkesel'), ('hubtel', 'Hubtel')], default='twilio', max_length=20)),
                ('sms_provider_config', models.JSONField(blank=True, default=dict, help_text='Provider-specific config (account SID, auth token, etc.)')),
                ('status', models.CharField(choices=[('pending', 'Pending Verification'), ('verified', 'Verified'), ('rejected', 'Rejected'), ('suspended', 'Suspended')], default='pending', max_length=15)),
                ('verified_at', models.DateTimeField(blank=True, null=True)),
                ('monthly_fee', models.DecimalField(decimal_places=2, default=0, help_text='Monthly whitelabel fee charged for this sender ID', max_digits=10)),
                ('is_active', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('client', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sender_ids', to='partner.otpclient')),
            ],
            options={
                'verbose_name': 'OTP Sender ID',
                'ordering': ['-created_at'],
                'unique_together': {('client', 'channel')},
            },
        ),
        migrations.CreateModel(
            name='OTPClientUsage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('date', models.DateField(db_index=True)),
                ('whatsapp_sent', models.PositiveIntegerField(default=0)),
                ('whatsapp_delivered', models.PositiveIntegerField(default=0)),
                ('whatsapp_failed', models.PositiveIntegerField(default=0)),
                ('sms_sent', models.PositiveIntegerField(default=0)),
                ('sms_delivered', models.PositiveIntegerField(default=0)),
                ('sms_failed', models.PositiveIntegerField(default=0)),
                ('total_verified', models.PositiveIntegerField(default=0)),
                ('total_expired', models.PositiveIntegerField(default=0)),
                ('whatsapp_cost', models.DecimalField(decimal_places=2, default=0, max_digits=10)),
                ('sms_cost', models.DecimalField(decimal_places=2, default=0, max_digits=10)),
                ('total_cost', models.DecimalField(decimal_places=2, default=0, max_digits=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('client', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='daily_usage', to='partner.otpclient')),
            ],
            options={
                'verbose_name': 'OTP Client Daily Usage',
                'verbose_name_plural': 'OTP Client Daily Usage',
                'ordering': ['-date'],
                'unique_together': {('client', 'date')},
            },
        ),
        migrations.CreateModel(
            name='OTPRequest',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('phone', models.CharField(db_index=True, max_length=20)),
                ('channel', models.CharField(choices=[('whatsapp', 'WhatsApp'), ('sms', 'SMS')], max_length=10)),
                ('code', models.CharField(help_text='Generated OTP code', max_length=8)),
                ('code_hash', models.CharField(blank=True, default='', help_text='SHA-256 hash of code for secure storage', max_length=64)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('sent', 'Sent'), ('delivered', 'Delivered'), ('failed', 'Failed'), ('expired', 'Expired'), ('verified', 'Verified'), ('rejected', 'Rejected (wrong code)')], db_index=True, default='pending', max_length=15)),
                ('expires_at', models.DateTimeField()),
                ('provider_message_id', models.CharField(blank=True, default='', help_text='Message ID from WhatsApp/SMS provider', max_length=100)),
                ('delivered_at', models.DateTimeField(blank=True, null=True)),
                ('delivery_attempts', models.PositiveSmallIntegerField(default=0)),
                ('error_message', models.TextField(blank=True, default='')),
                ('verified_at', models.DateTimeField(blank=True, null=True)),
                ('verify_attempts', models.PositiveSmallIntegerField(default=0, help_text='Number of incorrect verification attempts')),
                ('max_verify_attempts', models.PositiveSmallIntegerField(default=3)),
                ('cost', models.DecimalField(decimal_places=4, default=0, help_text='Cost charged for this OTP', max_digits=8)),
                ('billed', models.BooleanField(default=False)),
                ('client_ref', models.CharField(blank=True, default='', help_text='Client-provided reference for their own tracking', max_length=100)),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True, default='')),
                ('metadata', models.JSONField(blank=True, default=dict, help_text='Freeform metadata from client')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('api_key', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='partner.otpclientapikey')),
                ('client', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='otp_requests', to='partner.otpclient')),
                ('sender_id', models.ForeignKey(blank=True, help_text='Custom sender used (null=Cashflip default)', null=True, on_delete=django.db.models.deletion.SET_NULL, to='partner.otpsenderid')),
            ],
            options={
                'verbose_name': 'OTP Request',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['client', 'phone', 'status'], name='partner_otp_client__18601a_idx'), models.Index(fields=['client', 'created_at'], name='partner_otp_client__8af214_idx'), models.Index(fields=['phone', 'created_at'], name='partner_otp_phone_cbf608_idx')],
            },
        ),
    ]
