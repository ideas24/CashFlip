#cloud-config
package_update: true
package_upgrade: true

packages:
  - python3.10
  - python3.10-venv
  - python3-pip
  - nginx
  - certbot
  - python3-certbot-nginx
  - git
  - libpq-dev
  - build-essential
  - redis-tools

write_files:
  - path: /opt/cashflip/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      APP_DIR="/opt/cashflip/app"
      VENV_DIR="/opt/cashflip/venv"
      
      # Clone or pull repo
      if [ ! -d "$APP_DIR/.git" ]; then
        git clone https://github.com/YOUR_ORG/cashflip.git "$APP_DIR"
      else
        cd "$APP_DIR" && git pull origin master
      fi
      
      # Setup venv
      python3 -m venv "$VENV_DIR"
      "$VENV_DIR/bin/pip" install -r "$APP_DIR/requirements.txt"
      
      # Run migrations
      cd "$APP_DIR"
      "$VENV_DIR/bin/python" manage.py migrate --noinput
      "$VENV_DIR/bin/python" manage.py collectstatic --noinput
      "$VENV_DIR/bin/python" manage.py seed_data
      
      # Restart services
      systemctl restart cashflip.service
      
      echo "Deploy complete!"

  - path: /etc/systemd/system/cashflip.service
    content: |
      [Unit]
      Description=Cashflip Gunicorn
      After=network.target
      
      [Service]
      User=cashflip
      Group=cashflip
      WorkingDirectory=/opt/cashflip/app
      Environment="PATH=/opt/cashflip/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      EnvironmentFile=/opt/cashflip/.env
      ExecStart=/opt/cashflip/venv/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 60 --max-requests 1000 config.wsgi:application
      Restart=always
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  - useradd -r -s /bin/false cashflip || true
  - mkdir -p /opt/cashflip/app /opt/cashflip/logs
  - chown -R cashflip:cashflip /opt/cashflip
  - systemctl daemon-reload
  - systemctl enable cashflip.service
