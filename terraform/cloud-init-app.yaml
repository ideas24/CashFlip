#cloud-config
package_update: true
package_upgrade: true

packages:
  - python3.10
  - python3.10-venv
  - python3-pip
  - nginx
  - certbot
  - python3-certbot-nginx
  - git
  - libpq-dev
  - build-essential
  - redis-tools

write_files:
  - path: /opt/cashflip/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      APP_DIR="/opt/cashflip/app"
      VENV_DIR="/opt/cashflip/venv"
      
      # Clone or pull repo
      if [ ! -d "$APP_DIR/.git" ]; then
        git clone https://github.com/YOUR_ORG/cashflip.git "$APP_DIR"
      else
        cd "$APP_DIR" && git pull origin master
      fi
      
      # Setup venv
      python3 -m venv "$VENV_DIR"
      "$VENV_DIR/bin/pip" install -r "$APP_DIR/requirements.txt"
      
      # Run migrations
      cd "$APP_DIR"
      "$VENV_DIR/bin/python" manage.py migrate --noinput
      "$VENV_DIR/bin/python" manage.py collectstatic --noinput
      "$VENV_DIR/bin/python" manage.py seed_data
      
      # Restart services
      systemctl restart cashflip.service
      
      echo "Deploy complete!"

  - path: /etc/nginx/sites-available/cashflip.amoano.com
    content: |
      # Cashflip PRODUCTION - Game Subdomain
      limit_req_zone $binary_remote_addr zone=cf_general:10m rate=30r/s;
      limit_req_zone $binary_remote_addr zone=cf_api:10m rate=20r/s;
      limit_req_zone $binary_remote_addr zone=cf_auth:10m rate=5r/m;

      server {
          listen 80;
          server_name cashflip.amoano.com;
          return 301 https://$server_name$request_uri;
      }

      server {
          listen 443 ssl http2;
          server_name cashflip.amoano.com;

          add_header X-Frame-Options "DENY" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

          client_max_body_size 10M;

          location /static/ {
              alias /opt/cashflip/app/staticfiles/;
              expires 30d;
              access_log off;
          }

          location /media/ {
              alias /opt/cashflip/app/media/;
              expires 7d;
              access_log off;
          }

          # BLOCK admin on game subdomain
          location /admin/ {
              return 302 /;
          }

          location /api/accounts/auth/ {
              limit_req zone=cf_auth burst=3 nodelay;
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location /api/payments/webhooks/ {
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location /api/ {
              limit_req zone=cf_api burst=20 nodelay;
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location /health/ {
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              access_log off;
          }

          location /auth/ {
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location / {
              limit_req zone=cf_general burst=30 nodelay;
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }

  - path: /etc/nginx/sites-available/manage.cashflip.amoano.com
    content: |
      # Cashflip PRODUCTION - Admin Subdomain (hidden)
      server {
          listen 80;
          server_name manage.cashflip.amoano.com;
          return 301 https://$server_name$request_uri;
      }

      server {
          listen 443 ssl http2;
          server_name manage.cashflip.amoano.com;

          add_header X-Frame-Options "DENY" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

          client_max_body_size 20M;

          location /static/ {
              alias /opt/cashflip/app/staticfiles/;
              expires 30d;
              access_log off;
          }

          location /media/ {
              alias /opt/cashflip/app/media/;
              expires 7d;
              access_log off;
          }

          location /admin/ {
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location /health/ {
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              access_log off;
          }

          location / {
              return 302 /admin/;
          }
      }

  - path: /etc/systemd/system/cashflip.service
    content: |
      [Unit]
      Description=Cashflip Gunicorn
      After=network.target
      
      [Service]
      User=cashflip
      Group=cashflip
      WorkingDirectory=/opt/cashflip/app
      Environment="PATH=/opt/cashflip/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      EnvironmentFile=/opt/cashflip/.env
      ExecStart=/opt/cashflip/venv/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 60 --max-requests 1000 config.wsgi:application
      Restart=always
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  - useradd -r -s /bin/false cashflip || true
  - mkdir -p /opt/cashflip/app /opt/cashflip/logs
  - chown -R cashflip:cashflip /opt/cashflip
  - ln -sf /etc/nginx/sites-available/cashflip.amoano.com /etc/nginx/sites-enabled/
  - ln -sf /etc/nginx/sites-available/manage.cashflip.amoano.com /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t && systemctl reload nginx
  - certbot --nginx -d cashflip.amoano.com -d manage.cashflip.amoano.com --non-interactive --agree-tos --email admin@amoano.com || true
  - systemctl daemon-reload
  - systemctl enable cashflip.service
