#cloud-config
# ============================================================
# CashFlip Production â€” Celery VM Cloud-Init
# Provisions: Python, systemd celery service, deploy script
# After terraform apply, run: scripts/deploy-prod.sh --init
# ============================================================
package_update: true
package_upgrade: true

packages:
  - python3.10
  - python3.10-venv
  - python3-pip
  - git
  - libpq-dev
  - build-essential
  - redis-tools

write_files:
  # ---- SSH config for GitHub deploy key ----
  - path: /opt/cashflip/.ssh/config
    permissions: '0600'
    content: |
      Host github.com
        IdentityFile /opt/cashflip/.ssh/id_ed25519
        StrictHostKeyChecking no
        UserKnownHostsFile /dev/null

  # ---- On-VM deploy script ----
  - path: /opt/cashflip/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      APP_DIR="/opt/cashflip/app"
      VENV_DIR="/opt/cashflip/venv"
      SSH_KEY="/opt/cashflip/.ssh/id_ed25519"
      GIT_SSH="ssh -i $SSH_KEY -o StrictHostKeyChecking=no"
      LOG="/opt/cashflip/logs/deploy.log"
      
      log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG"; }
      
      log "=== CashFlip Celery Deploy START ==="
      
      if [ ! -f "$SSH_KEY" ]; then
        log "ERROR: Deploy key not found at $SSH_KEY"
        exit 1
      fi
      
      if [ ! -f /opt/cashflip/.env ]; then
        log "ERROR: /opt/cashflip/.env not found"
        exit 1
      fi
      
      # Clone or pull
      if [ ! -d "$APP_DIR/.git" ]; then
        log "Cloning repository..."
        GIT_SSH_COMMAND="$GIT_SSH" git clone git@github.com:ideas24/CashFlip.git "$APP_DIR"
        chown -R cashflip:cashflip "$APP_DIR"
      else
        log "Pulling latest from master..."
        cd "$APP_DIR"
        GIT_SSH_COMMAND="$GIT_SSH" git pull origin master
      fi
      
      # Virtualenv
      if [ ! -d "$VENV_DIR" ]; then
        log "Creating virtualenv..."
        python3 -m venv "$VENV_DIR"
      fi
      log "Installing requirements..."
      "$VENV_DIR/bin/pip" install --quiet --upgrade pip
      "$VENV_DIR/bin/pip" install --quiet -r "$APP_DIR/requirements.txt"
      
      # Restart celery
      log "Restarting cashflip-celery.service..."
      systemctl restart cashflip-celery.service
      
      log "=== CashFlip Celery Deploy COMPLETE ==="

  # ---- Systemd: Celery worker ----
  - path: /etc/systemd/system/cashflip-celery.service
    content: |
      [Unit]
      Description=Cashflip Celery Worker
      After=network.target

      [Service]
      User=cashflip
      Group=cashflip
      WorkingDirectory=/opt/cashflip/app
      Environment="PATH=/opt/cashflip/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      EnvironmentFile=/opt/cashflip/.env
      ExecStart=/opt/cashflip/venv/bin/celery -A config worker -l info -c 4 -Q default,game --without-heartbeat
      Restart=always
      RestartSec=10
      StandardOutput=append:/opt/cashflip/logs/celery_worker.log
      StandardError=append:/opt/cashflip/logs/celery_worker.log

      [Install]
      WantedBy=multi-user.target

runcmd:
  - useradd -r -m -s /bin/bash cashflip || true
  - mkdir -p /opt/cashflip/app /opt/cashflip/logs /opt/cashflip/.ssh
  - chown -R cashflip:cashflip /opt/cashflip
  - chmod 700 /opt/cashflip/.ssh
  - systemctl daemon-reload
  - systemctl enable cashflip-celery.service
